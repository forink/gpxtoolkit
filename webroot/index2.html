<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>里程產生器</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
  <style>
  </style>
</head>

<body class="bg-light">
  <noscript>
    <strong>We're sorry but this site won't work properly without JavaScript enabled. Please enable it to
      continue.</strong>
  </noscript>

  <div id="app" class="container-fluid min-vh-100 d-flex flex-column">
    <nav class="row navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">{{gpxFile ? gpxFile.name : '里程產生器'}}</a>
        <div>
          <button v-if="gpxFile" type="button" class="btn btn-primary" @click="preview()">預覽</button>
          <button v-if="gpxFile" type="button" class="btn btn-danger" @click="clear()">清除</button>
          <div v-if="gpxFile" class="btn-group" role="group">
            <button id="btnGroupDrop1" type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown"
              aria-expanded="false">
              下載
            </button>
            <div class="dropdown-menu">
              <button type="button" class="dropdown-item" @click="downloadGpx()">GPX</button>
              <button type="button" class="dropdown-item" @click="downloadCsv()">CSV</button>
            </div>
          </div>
        </div>
        <form v-if="!gpxFile" class="d-flex">
          <input class="form-control" type="file" id="gpx-file" name="gpx-file" accept=".gpx" required
            @change="previewGpx">
        </form>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          </ul>
        </div>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
          aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
    </nav>
    <div v-if="gpxFile" id="options" class="row py-1">
      <div class="col-sm-6">
        <label for="distance" class="form-label">里程間距</label>
        <div class="input-group">
          <input type="number" class="form-control" id="distance" required aria-describedby="distance-addon2"
            v-model="distance">
          <span class="input-group-text" id="distance-addon2">公尺</span>
        </div>
        <div class="invalid-feedback">
          請輸入里程間距
        </div>
      </div>
      <div class="col-sm-6">
        <label for="name-template" class="form-label">里程航點名稱樣版</label>
        <div class="input-group">
          <input type="text" class="form-control" id="name-template" required aria-describedby="name-template-addon2"
            v-model="nameTemplate">
          <button class="btn btn-outline-primary" type="button" id="name-template-addon2" data-bs-toggle="modal"
            data-bs-target="#nameTemplateModal">說明</button>
        </div>
        <div class="invalid-feedback">
          請輸入里程航點名稱樣版
        </div>
      </div>
      <div class="col-sm-6">
        <input type="checkbox" class="form-check-input" id="reverse" v-model="reverse">
        <label class="form-check-label" for="reverse">反向產生里程航點</label>
      </div>
    </div>
    <div id="map" class="row flex-grow-1"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue-cookies@1.7.4/vue-cookies.min.js"></script>
  <script src='togeojson.js'></script>
  <script>
    function encodeQueryData(data) {
      const ret = [];
      for (let d in data) {
        ret.push(encodeURIComponent(d) + '=' + encodeURIComponent(data[d]));
      }
      return ret.join('&');
    }
    new Vue({
      el: '#app',
      data: {
        center: [23.47, 120.957283],
        zoom: 15,
        map: null,
        gpxFile: null,
        gpxLayer: null,
        distance: '100',
        nameTemplate: '{{printf "%.1f" .Kilometer}}K',
        reverse: false,
      },
      mounted() {
        this.map = L.map('map').setView(this.center, this.zoom);
        L.tileLayer('https://rs.happyman.idv.tw/map/moi_osm/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap'
        }).addTo(this.map);
      },
      watch: {
        gpxFile: function (gpxFile) {
          if (!gpxFile) return;
          console.log(gpxFile);
          var reader = new FileReader();
          var self = this;
          reader.onload = function (event) {
            self.loadGpx(event.target.result);
          };
          reader.readAsDataURL(gpxFile);

          reader = new FileReader();
          reader.onload = function (event) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(event.target.result, "application/xml");
            console.log(toGeoJSON.kml(doc))
          };
          reader.readAsText(gpxFile);
        },
      },
      methods: {
        previewGpx(event) {
          this.gpxFile = event.target.files[0];
        },
        loadGpx(url) {
          var self = this;
          if (this.gpxLayer) {
            this.map.removeLayer(this.gpxLayer);
          }
          this.gpxLayer = new L.GPX(url, {
            async: true,
            marker_options: {
              wptIconUrls: {
                '': 'https://github.com/mpetazzoni/leaflet-gpx/blob/main/pin-icon-wpt.png?raw=true',
              },
              startIconUrl: 'https://github.com/mpetazzoni/leaflet-gpx/blob/main/pin-icon-start.png?raw=true',
              endIconUrl: 'https://github.com/mpetazzoni/leaflet-gpx/blob/main/pin-icon-end.png?raw=true',
              shadowUrl: 'https://github.com/mpetazzoni/leaflet-gpx/blob/main/pin-shadow.png?raw=true',
            },
          }).on('loaded', function (event) {
            var gpx = event.target;
            self.map.fitBounds(gpx.getBounds());
          }).addTo(self.map);
        },
        clear() {
          this.gpxFile = null;
          if (this.gpxLayer) {
            this.map.removeLayer(this.gpxLayer);
            this.gpxLayer = null;
          }
        },
        preview() {
          var self = this;
          var xhr = new XMLHttpRequest();
          var data = { 'distance': this.distance, 'name-template': this.nameTemplate, 'reverse': this.reverse, 'format': 'gpx' };
          xhr.open("POST", "/cgi/milestones?" + encodeQueryData(data));
          xhr.setRequestHeader("Content-Type", "application/gpx+xml");
          xhr.onload = function () {
            if (xhr.status != 200) {
              console.error(xhr.responseText);
            } else {
              self.loadGpx(xhr.response);
            }
          };
          xhr.send(this.gpxFile);
        },
        downloadGpx() {

        },
        downloadCsv() {

        },
      }
    });
  </script>
</body>

</html>